'use strict'

const mongo = require('../../db/mongoClient')()
const positionClient = require('../position/core-position')
const {getConfig} = require('../../util/breezy-config')
const config = getConfig()

const LOG_NS = '[CORE-RECRUITER]'
const RECRUITER_COLLECTION = 'recruiter'
const USER_NIMBLEBOT = 'nimblebot'

module.exports = {
  getRecruiterById
}

/**
 * Get a recruiter from by their id
 * @param recruiterId
 * @returns {Promise<*>}
 */
async function getRecruiterById(recruiterId) {

  if (recruiterId === USER_NIMBLEBOT) {
    return config.NimbleBot
  }

  let recruiter = await getRecruiter({'_id': recruiterId})

  if (recruiter) {
    let position = await positionClient.getPositionById(recruiter.position_id)
    recruiter.is_active = (position && position.status === 'published')
  }

  return recruiter
}

/**
 * Gets a recruiter from the db
 * @param criteria
 * @returns {Promise<*>}
 */
async function getRecruiter(criteria) {

  try {
    return mongo.getDocumentAsync({
      collection: RECRUITER_COLLECTION,
      criteria: criteria
    })
  } catch (e) {
    console.error(LOG_NS, e)
  }
}
